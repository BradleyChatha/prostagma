---
kind: pipeline
type: docker
name: Default

steps:
  - name: Build
    image: dlangchina/dlang-dmd
    commands:
      - apt-get update
      - apt-get -y upgrade
      - apt-get -y install libssl-dev
      - dub build -b release
      - mkdir dist
      - cp ./prostagma ./dist/prostagma-linux64
  - name: Release
    image: plugins/github-release
    settings:
      api_key:
        from_secret: GITHUB_API_KEY
      files: dist/prostagma-linux64
      checksum:
        - md5
    when:
      event:
        - tag
  - name: Publish
    image: plugins/docker
    settings:
      username:
          from_secret: DOCKER_USERNAME
      password:
          from_secret: DOCKER_PASSWORD
      repo: bradleychatha/prostagma
      tags: latest
    when:
      event:
        - tag

trigger:
  branch:
    - master